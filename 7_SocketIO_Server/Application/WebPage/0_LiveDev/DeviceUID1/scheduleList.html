<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Schedule List Interface</title>
<script>
  var deviceUID = 'DeviceUID1';  //<-------------- USER MUST CHANGE THIS
</script>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 0;
    background-color: #f4f4f4;
  }
  .schedule-list {
    list-style: none;
    padding: 0;
    margin: 20px;
  }
  .schedule-list li {
    background: #fff;
    margin-bottom: 10px;
    border: 3px solid #2196F3; /* Default blue border */
    padding: 10px 20px;
    font-size: 18px;
    border-radius: 40px;
  }
  .schedule-list li.off {
    border-color: #f44336; /* Red border for OFF status */
  }
  .status {
    font-weight: bold;
  }
  .status.on {
    color: #007BFF; /* Green color for ON status */
    font-size: larger;
    font-weight: bold;
    margin-right: 10px;
  }
  .status.off {
    color: #f44336; /* Red color for OFF status */
    font-size: larger;
    font-weight: bold;
    margin-right: 10px;
  }
  .add-btn {
    position: fixed;
    bottom: 32px;
    right: 30px;
    background-color: #007BFF; /* Green background */
    color: white;
    border: none;
    border-radius: 50%;
    width: 80px;
    height: 80px;
    font-size: 50px;
    font-weight: bold;
    line-height: 60px;
    text-align: center;
    cursor: pointer;
    padding-bottom: 10px;
  }
</style>

<!-- ==================================================================== -->
<!-- CSS FOR POPUP  -->
<style>
  /* Styles for Popup */
  .popup {
    display: none;
    position: fixed;
    z-index: 1;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.4);
  }
  .popup-content {
    background-color: #fefefe;
    margin: 1% auto;
    padding: 20px;
    border: 1px solid #888;
    width: 40%;
  }
  .close {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
  }
  .close:hover,
  .close:focus {
    color: black;
    text-decoration: none;
    cursor: pointer;
  }

  .header {
    background-color: #007BFF;
    color: white;
    text-align: center;
    padding: 20px;
    font-size: 24px;
    font-weight: bold;
  }
  .form-container {
    background: #fff;
    margin: 20px;
    padding: 20px;
    border-radius: 10px;
    padding: 0px;
  }
  .form-group {
    margin-bottom: 15px;
  }
  label {
    display: block;
    margin-bottom: 5px;
  }
  input[type="text"],
  input[type="date"],
  input[type="time"],
  .until-date {
    width: 100%;
    padding: 10px;
    margin: 5px 0;
    border-radius: 5px;
    border: 1px solid #ddd;
    box-sizing: border-box; /* So that width includes padding */
  }
  .toggle-switch {
    position: relative;
    display: inline-block;
    width: 60px;
    height: 34px;
    margin-left: 10px;
  }
  .toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
  }
  .slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: .4s;
    border-radius: 34px;
  }
  .slider:before {
    position: absolute;
    content: "";
    height: 26px;
    width: 26px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
  }
  input:checked + .slider {
    background-color: #2196F3;
  }
  input:focus + .slider {
    box-shadow: 0 0 1px #2196F3;
  }
  input:checked + .slider:before {
    transform: translateX(26px);
  }
  .channel-buttons {
    display: flex;
    justify-content: space-between;
  }
  .channel-btn{
    font-weight: bold;
  }
  .channel-buttons button {
    flex: 1;
    padding: 10px;
    margin: 0 2px;
    border: 1px solid #ddd;
    background-color: #f4f4f4;
    border-radius: 5px;
  }
  .channel-buttons button.active {
    background-color: #007BFF;
    color: white;
  }
  .radio-group {
    display: flex;
    justify-content: space-between;
    margin: 20px 0;
  }
  .radio-group input[type="radio"] {
    display: none; /* Hide the default radio button */
  }
  .radio-group label {
    padding: 10px 20px;
    border: 1px solid #ddd;
    border-radius: 5px;
    margin: 0 5px;
  }
  .radio-group input[type="radio"]:checked + label {
    background-color: #007BFF;
    color: white;
  }
  .day-buttons {
    display: flex;
    justify-content: space-around;
    flex-wrap: wrap;
  }
  .day-buttons button {
    padding: 5px 10px;
    margin: 5px;
    border: 1px solid #ddd;
    background-color: #f4f4f4;
    border-radius: 5px;
  }
  .day-buttons button.active {
    background-color: #007BFF;
    color: white;
  }
  .until-date {
    width: auto;
    display: inline-block;
  }

</style>
<!-- <script src="/0_LiveDev/commmon/script.js"></script>
<link rel="stylesheet" href="/0_LiveDev/commmon/styles.css"> -->
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.1.2/socket.io.js"></script>
<script>const socket = io();</script>
</head>
<body>
<!-- ==================================================================== -->
<!-- 1.  SCHEDULE LIST -->
<div class="header">SCHEDULE LIST</div>
<ul class="schedule-list">
  <!-- Schedule items will be added here -->
</ul>
<button class="add-btn" id="addBtn">+</button>

<!-- ==================================================================== -->
<!-- 2. Popup Form -->
<div id="schedulePopup" class="popup">
  <div class="popup-content">
    <span class="close">&times;</span>
    <form id="scheduleForm">

      <div class="header addEditSchedule">
        ADD NEW SCHEDULE
      </div>
      
      <div class="form-container">
        <div class="form-group">
          <label for="title" style="font-weight: bold;">Add title</label>
          <input type="text" id="title" placeholder="Enter title here">
        </div>
        
        <div class="form-group">
          <label style="font-weight: bold;">From</label>
          <input type="date" id="date-picker" value="2023-09-01">
          <input type="time" id="time-picker" value="09:45">
        </div>
        
        <div class="form-group">
          <label style="font-weight: bold;">Action</label>
          <div class="toggle-switch" onclick="toggleAction()">
            <input type="checkbox" id="action-toggle" checked>
            <span class="slider"></span>
          </div>
        </div>
        
        <div class="form-group">
          <label style="font-weight: bold;">Channel</label>
          <div class="channel-buttons">
            <button type="button" class="channel-btn active" onclick="selectChannel(1)">CHANNEL 1</button>
            <button type="button" class="channel-btn"        onclick="selectChannel(2)">CHANNEL 2</button>
            <button type="button" class="channel-btn"        onclick="selectChannel(3)">CHANNEL 3</button>
            <button type="button" class="channel-btn"        onclick="selectChannel(4)">CHANNEL 4</button>
          </div>
        </div>
        
        <div class="form-group">
          <label style="font-weight: bold;">Repeat</label>
          <div class="channel-buttons repeat-buttons">
            <button type="button" id="norepeat" class="repeat-btn active" onclick="selectRepeat('NoRepeat')">No Repeat</button>
            <button type="button" id="daily"    class="repeat-btn"        onclick="selectRepeat('Daily')">Daily</button>
            <button type="button" id="weekdays" class="repeat-btn"        onclick="selectRepeat('Weekdays')">Weekdays</button>
            <button type="button" id="monthly"  class="repeat-btn"        onclick="selectRepeat('Monthly')">Monthly</button>
          </div>
          <div class="channel-buttons day-buttons">
            <button type="button" class="day-btn" onclick="selectDay('Sun')" disabled>Sun</button>
            <button type="button" class="day-btn" onclick="selectDay('Mon')" disabled>Mon</button>
            <button type="button" class="day-btn" onclick="selectDay('Tue')" disabled>Tue</button>
            <button type="button" class="day-btn" onclick="selectDay('Wed')" disabled>Wed</button>
            <button type="button" class="day-btn" onclick="selectDay('Thu')" disabled>Thu</button>
            <button type="button" class="day-btn" onclick="selectDay('Fri')" disabled>Fri</button>
            <button type="button" class="day-btn" onclick="selectDay('Sat')" disabled>Sat</button>
          </div>
        </div>
        
        <div class="form-group">
          <label style="font-weight: bold;">Until</label>
          <input class="until-date" type="date" id="until-date-picker" value="2024-07-01">
        </div>
        <br>
        <div class="form-group" style="text-align: center;">
          <button type="submit" class="btn btn-primary" onclick="saveSchedule()" style="font-weight: bold;">SAVE</button>
          <button type="button" class="btn btn-secondary" onclick="closePopup()" style="font-weight: bold;">CANCEL</button>
        </div>
      </div>
    </form>
  </div>
</div>






<!-- ==================================================================== -->
<!-- ==================================================================== -->
<!-- ==================================================================== -->
<!-- ==================================================================== -->
<!-- 1. SCHEDULE LIST SCRIPT -->
<script>
  var schedeleListData = null; // Lưu trữ danh sách các schedule
  var refreshScheduleListRequestFlag = false;
  var modifyScheduleRequestFlag = false;
  var modifyScheduleIndex = -1;
  // 1. Load schedules from Local storage
  function __addHandleEventToEditDelButtons() {
    // Sử dụng một biến để lưu trữ thông tin của schedule đang được chỉnh sửa
    let editingSchedule = null;

    // Thêm sự kiện click cho nút "Edit" trên mỗi thẻ schedule
    const editButtons = document.querySelectorAll('.edit-btn');
    editButtons.forEach((editButton, index) => {
      editButton.addEventListener('click', () => {
        // Change the title of popup "ADD NEW SCHEDULE" to "EDIT SCHEDULE"
        document.querySelector('.addEditSchedule').textContent = 'EDIT SCHEDULE';
        // Lưu trữ thông tin của schedule đang được chỉnh sửa
        editingSchedule = schedeleListData[index];
        // Hiển thị thông tin của schedule trong popup

        document.getElementById('title').value = editingSchedule.title;
        document.getElementById('date-picker').value = editingSchedule.fromDate;
        document.getElementById('time-picker').value = editingSchedule.fromTime;
        document.getElementById('action-toggle').checked = editingSchedule.action === 'on';
        //Check the node of channel button which has the same value with editingSchedule.channel
        //uncheck the other nodes of channel button
        const channelButtons = document.querySelectorAll('.channel-buttons button');
        channelButtons.forEach((channelButton, index) => {
          if (index + 1 == editingSchedule.channel) {
            channelButton.classList.add('active');
          } else {
            channelButton.classList.remove('active');
          }
        });
        //Active the node of repeat button which has the same value with editingSchedule.repeat
        //Deactive the other nodes of repeat button
        const repeatButtons = document.querySelectorAll('.repeat-buttons button');
        repeatButtons.forEach((repeatButton) => {
          repeatButton.classList.remove('active');
        });
        repeatButtons.forEach((repeatButton) => {
          if (repeatButton.textContent == editingSchedule.repeat) {
            repeatButton.classList.add('active');
          }
        });
        //Active the node of day button which has the same value with editingSchedule.daysOfWeek
        //Deactive the other nodes of day button
        const dayButtons = document.querySelectorAll('.day-buttons button');
        if (editingSchedule.repeat === 'weekdays') {
          dayButtons.forEach((dayButton) => {
            dayButton.removeAttribute("disabled");
            dayButton.classList.remove('active');
            dayButton.style.borderColor = "#007BFF"; //Change border color of weekdays buttons to blue
          });
        }
        else if (editingSchedule.repeat === 'daily') {
          dayButtons.forEach((dayButton) => {
            dayButton.classList.add('active');
          });
        }
        else {
          dayButtons.forEach((dayButton) => {
            dayButton.setAttribute("disabled", "disabled");
            dayButton.classList.remove('active');
            dayButton.style.borderColor = "#ddd"; //Remove border color of weekdays buttons
          });
        }
        dayButtons.forEach((dayButton) => {
          dayButton.classList.remove('active');
        });
        editingSchedule.daysOfWeek.forEach((day) => {
          document.querySelector('.day-buttons button:nth-child(' + (["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"].indexOf(day) + 1) + ')').classList.add('active');
        });
        document.getElementById('until-date-picker').value = editingSchedule.untilDate;

        // Hiển thị popup
        modifyScheduleRequestFlag = true; // Yêu cầu cập nhật lại danh sách schedule
        modifyScheduleIndex = index;
        document.getElementById('schedulePopup').style.display = 'block';

      });
    });
    // Thêm sự kiện click cho nút "Xóa" trên mỗi thẻ schedule. Nếu nhấn nút thì xóa schedule đó và lưu lại vào local storage.
    const deleteButtons = document.querySelectorAll('.delete-btn');
    deleteButtons.forEach((deleteButton, index) => {
      deleteButton.addEventListener('click', () => {
        // Show the popup to confirm delete
        if (!confirm('Are you sure to delete this schedule?')) return;
        schedeleListData.splice(index, 1); // Xóa schedule khỏi danh sách
        localStorage.setItem("LOCAL_STORE_SCHEDULE_LIST_"+deviceUID, JSON.stringify(schedeleListData)); // Lưu lại vào local storage
        // emit to server to delete schedule
        socket.emit('SOCKET', {action: 'delete', index: index});  // <----------------------- CẬP NHẬT LẠI
        refreshScheduleListRequestFlag = true; // Yêu cầu cập nhật lại danh sách schedule
      });
    });
  }

  function loadSchedules() {
    console.log('Loading schedules...');
    const scheduleList = document.querySelector('.schedule-list');
    scheduleList.innerHTML = ''; // Xóa nội dung hiện tại
    schedeleListData = JSON.parse(localStorage.getItem("LOCAL_STORE_SCHEDULE_LIST_"+deviceUID)); // Load from local storage
    schedeleListData.forEach(schedule => {
      const scheduleItem = document.createElement('li');
      scheduleItem.className = schedule.action === 'on' ? '' : 'off';
      if (schedule.repeat === 'Weekdays') {
        scheduleItem.innerHTML = `
        <span class="status ${schedule.action}">${schedule.action.toUpperCase()}</span> ${schedule.title}  Channel ${schedule.channel} - From: ${schedule.fromDate} ${schedule.fromTime} - Repeat: ${schedule.repeat} - ${schedule.daysOfWeek.join(', ')} - Until: ${schedule.untilDate} 
        <button class="edit-btn">Edit</button>
        <button class="delete-btn">Delete</button>
        `;
      }
      else {
        scheduleItem.innerHTML = `
        <span class="status ${schedule.action}">${schedule.action.toUpperCase()}</span> ${schedule.title}  Channel ${schedule.channel} - From: ${schedule.fromDate} ${schedule.fromTime} - Repeat: ${schedule.repeat} - Until: ${schedule.untilDate} 
        <button class="edit-btn">Edit</button>
        <button class="delete-btn">Delete</button>
        `;
      }

      // Thêm các thành phần khác của schedule vào đây nếu cần
      scheduleList.appendChild(scheduleItem);
    });
    __addHandleEventToEditDelButtons(); //Add handle event to edit and delete buttons
  }
  document.addEventListener('DOMContentLoaded', loadSchedules);


  //2. Check refreshScheduleListRequestFlag to refresh schedule list every 0.1s
  setInterval(function() {
    if (refreshScheduleListRequestFlag) {
      console.log('INVERVAL: Refreshing schedule list...');
      loadSchedules();
      refreshScheduleListRequestFlag = false;
    }
  }, 100);
</script>
<!-- ==================================================================== -->
<!-- 2. Popup Script -->
<script>
  //JavaScript for Popup
  modifyScheduleRequestFlag = false; // Reset flag of modify schedule request
  //1. Edit button to open popup
  document.getElementById("addBtn").onclick = function() {
    document.querySelector('.addEditSchedule').textContent = 'ADD NEW SCHEDULE';
    // Reset form
    document.getElementById('title').value = '';
    document.getElementById('date-picker').value = new Date().toISOString().slice(0, 10);
    document.getElementById('time-picker').value = new Date().toLocaleTimeString('en-US', { hour12: false, hour: "numeric", minute: "numeric" });
    document.getElementById('action-toggle').checked = true;
    selectChannel(1);
    selectRepeat('NoRepeat');
    var untilDate = new Date();
    untilDate.setFullYear(untilDate.getFullYear() + 1);
    document.getElementById('until-date-picker').value = untilDate.toISOString().slice(0, 10);
    // Display popup
    document.getElementById("schedulePopup").style.display = "block";
  };
  document.getElementsByClassName("close")[0].onclick = function() {
    modifyScheduleRequestFlag = false; // Reset flag of modify schedule request
    document.getElementById("schedulePopup").style.display = "none";
  };
  function closePopup() {
    modifyScheduleRequestFlag = false; // Reset flag of modify schedule request
    document.getElementById("schedulePopup").style.display = "none";
  }

  //2. Save button in popup
  function saveSchedule() {
    event.preventDefault(); // Ngăn chặn load lại trang khi nhấn nút Save
    // Lấy thông tin từ form
    const scheduleData = {
      title: document.getElementById('title').value,
      fromDate: document.getElementById('date-picker').value,
      fromTime: document.getElementById('time-picker').value,
      action: document.getElementById('action-toggle').checked ? 'on' : 'off',
      channel: Array.from(document.querySelectorAll('.channel-buttons button'))
                    .findIndex(button => button.classList.contains('active')) + 1,
      repeat: document.querySelector('.repeat-buttons button.active').textContent,
      daysOfWeek: Array.from(document.querySelectorAll('.day-buttons button.active'))
                        .map(button => button.textContent),
      untilDate: document.getElementById('until-date-picker').value
    };
    socket.emit('SOCKET', scheduleData); // Gửi dữ liệu lên server // <----------- CẬP NHẬT LẠI
    console.log('Schedule data:', scheduleData);
    // Store to local storage
    // If modifyScheduleRequestFlag is true, modify the schedule in schedeleListData
    // Else, add new schedule to schedeleListData
    if (modifyScheduleRequestFlag) {
      schedeleListData[modifyScheduleIndex] = scheduleData; // Modify schedule in schedeleListData
      modifyScheduleRequestFlag = false; // Reset flag of modify schedule request
    }
    else {
      schedeleListData.push(scheduleData);
    }
    localStorage.setItem("LOCAL_STORE_SCHEDULE_LIST_"+deviceUID, JSON.stringify(schedeleListData));
    document.getElementById('schedulePopup').style.display = 'none'; // Ẩn popup sau khi xử lý xong
    refreshScheduleListRequestFlag = true; // Yêu cầu cập nhật lại danh sách schedule
  }

  //3. Reactive button in popup
  function toggleAction() {
    var actionToggle = document.getElementById("action-toggle");
    actionToggle.checked = !actionToggle.checked;
  }

  function selectChannel(channelNumber) {
    var channelButtons = document.querySelectorAll(".channel-btn");
    channelButtons.forEach(function(button, index) {
      if (index + 1 === channelNumber) {
        button.classList.add("active");
      } else {
        button.classList.remove("active");
      }
    });
  }

  function selectRepeat(repeatType) {
    var repeatButtons = document.querySelectorAll(".repeat-btn");
    repeatButtons.forEach(function(button) {
      button.classList.remove("active");
    });

    var weekdaysButtons = document.querySelectorAll(".day-buttons button");
    weekdaysButtons.forEach(function(button) {
      button.classList.remove("active");
      button.setAttribute("disabled", "disabled");
    });

    if (repeatType === 'Daily') {
      // Select all weekdays
      weekdaysButtons.forEach(function(button) {
        button.classList.add("active");
        //button.style.fontWeight = "bold";
      });
    }
    else if (repeatType === 'Weekdays') {
      weekdaysButtons.forEach(function(button) {
        button.removeAttribute("disabled");
        button.classList.remove("active");
        button.style.borderColor = "#007BFF"; //Change border color of weekdays buttons to blue
      });
    }
    else {
      weekdaysButtons.forEach(function(button) {
        button.style.borderColor = "#ddd"; //Remove border color of weekdays buttons
      });
    }

    var selectedRepeatButton = document.getElementById(repeatType.toLowerCase());
    selectedRepeatButton.classList.add("active");
  }

  function selectDay(day) {
    var weekdaysRadio = document.getElementById("weekdays");
    var dayButton = document.querySelector(".day-buttons button:nth-child(" + (["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"].indexOf(day) + 1) + ")");
    
    if (weekdaysRadio.classList.contains("active")) {
      var isActive = dayButton.classList.contains("active");
      dayButton.classList.toggle("active", !isActive);
    } else {
      dayButton.classList.toggle("active");
    }
  }
</script>

</body>
</html>
